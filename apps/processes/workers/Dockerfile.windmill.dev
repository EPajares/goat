# Windmill Worker - Development (fat image with all deps)
# goatlib is mounted at runtime, no Python deps needed here

ARG PYTHON_IMAGE_TAG='3.12-slim-bookworm'
ARG WINDMILL_IMAGE_TAG='main'

# Extract windmill binary
FROM ghcr.io/windmill-labs/windmill:${WINDMILL_IMAGE_TAG} AS windmill

# Build on Python base image
FROM python:${PYTHON_IMAGE_TAG}

ARG APP=/usr/src/app
ENV TZ=Etc/UTC

# Copy windmill binary
COPY --from=windmill /usr/src/app/windmill ${APP}/windmill
RUN ln -s ${APP}/windmill /usr/local/bin/windmill

# Install uv for Python package management (required by Windmill)
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# Install system dependencies for geospatial processing + Playwright
RUN apt-get update && apt-get install -y --no-install-recommends \
    # GDAL/GEOS for geospatial
    gdal-bin \
    libgdal-dev \
    libgeos-dev \
    libproj-dev \
    # Virtual display for headless rendering
    xvfb \
    # Playwright browser deps
    libnss3 \
    libnspr4 \
    libatk1.0-0 \
    libatk-bridge2.0-0 \
    libcups2 \
    libdrm2 \
    libxkbcommon0 \
    libxcomposite1 \
    libxdamage1 \
    libxfixes3 \
    libxrandr2 \
    libgbm1 \
    libasound2 \
    libpango-1.0-0 \
    libcairo2 \
    fonts-liberation \
    fonts-noto-color-emoji \
    && rm -rf /var/lib/apt/lists/*

# Install Playwright, browser, and PDF tools
ENV PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
RUN pip install --no-cache-dir playwright pypdf httpx && \
    playwright install chromium --with-deps

WORKDIR ${APP}

ENV DISABLE_SERVER=true
ENV PYTHON_PATH=/usr/local/bin/python3

CMD ["windmill"]
